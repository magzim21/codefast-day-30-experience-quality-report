# Uncomment required Jobs and Steps as needed

# AWS_REGION:      # Set via GitHub Secrets and variables on a org level
# AWS_ACCOUNT_ID:  # Set via GitHub Secrets and variables on a org level
# APP_NAME:        # Set via GitHub Secrets and variables on a repo level

---
name: main
run-name: ${{ github.event_name == 'schedule' && 'scheduled üóìÔ∏è' || format('{0} - {1} üèóÔ∏è', github.actor, github.event.head_commit.message) }}
on:
  push:
    branches:
      - prod
      - stg
      - dev
  schedule: # A regular sync to prevent drifts.
    - cron: "0 8 * * 1" # every day at 8am UTC Monday # https://crontab.guru/#0_8_*_*_*
  workflow_dispatch: {}
# env:
#   AWS_REGION: ${{ vars.AWS_REGION }} # Set via GitHub Secrets and variables on a org level
#   AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}  # Set via GitHub Secrets and variables on a org level
#   APP_NAME: ${{ vars.APP_NAME }}        # Set via GitHub Secrets and variables on a repo level
#   ROLE_ARN: ${{ secrets.ROLE_ARN }}     # Set via GitHub Secrets on a repo level
jobs:
  tests:
    name: Run Tests
    permissions:
      contents: read
      id-token: write # This is required for requesting the JWT
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # fetching all history to scan for secrets

      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}} # Only required for Organizations, not personal accounts.
          GITLEAKS_VERSION: 8.24.3
      # - name: Configure AWS Credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-region: ${{ vars.AWS_REGION }} # Set via GitHub Secrets and variables on an org level
      #     role-to-assume:  ${{ vars.AWS_ECR_ROLE_ARN }}
      # - name: Login to Amazon ECR
      #   id: login-ecr
      #   uses: aws-actions/amazon-ecr-login@v2
      # - uses: azure/setup-helm@v4.2.0
      #   with:
      #     version: 'latest' # default is latest (stable)

      - name: Setup Node.js for commitlint
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
      - name: Check if the commit message is properly formatted
        run: |
          npm install -g @commitlint/config-conventional
          npx commitlint --config ".githooks/.commitlintrc.yml" --last --verbose

      # - name: Run terraform formatting
      #   run: terraform fmt -recursive  -check

  next-version:
    name: Determine the next version
    runs-on: ubuntu-latest
    needs:
      - tests
    permissions:
      contents: write # to be able to publish a GitHub release
    outputs:
      should-run-build: ${{ steps.decision.outputs.should-run-build }}
      semver_tag: ${{ steps.decision.outputs.semver_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js for semantic-release
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
      - name: Decide whether to release
        id: decision
        # env:
        # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # TODO / remove this
        run: |
          # Check if there are any changes that are relevant for the release
          SEMVER_TAG=$(npx semantic-release --dry-run  | awk '/next release version is/ {print $NF}')
          echo "SEMVER_TAG: ${SEMVER_TAG}"
          if [[ -n "${SEMVER_TAG}" ]]; then
            echo "should-run-build=True" >> "$GITHUB_OUTPUT"
            echo "semver_tag=$SEMVER_TAG" >> $GITHUB_OUTPUT
            echo "#### Found features/fixes. The next version will be ${SEMVER_TAG}... :punch:" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "should-run-build=False" >> "$GITHUB_OUTPUT"
            echo "#### No features, no fixes. Skipping Build job :police_car:" | tee -a $GITHUB_STEP_SUMMARY
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    if: needs.next-version.outputs.should-run-build == 'True'
    needs: next-version
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # fetching all history to scan for secrets
      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Build the project
        run: |
          echo "This is already a static website, so no build is needed."

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: .
  deploy:
    name: Deploy
    permissions:
      contents: read
      pages: write
      id-token: write
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{steps.deployment.outputs.page_url}}
    steps:
      - name: Deploy artifact
        id: deployment
        uses: actions/deploy-pages@v4
  
  git-tag-release:
    name: Create ${{ needs.next-version.outputs.semver_tag }} git tag
    runs-on: ubuntu-latest
    needs:
      - deploy
      - next-version
    permissions:
      contents: write # to be able to publish a GitHub release
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js for semantic-release
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
      - name: Create a semanitc git tag  
        # env:
        # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # TODO / remove this
        run: |
          npx semantic-release
          echo "#### Created a git tag ${{ needs.next-version.outputs.semver_tag }} üêô" | tee -a $GITHUB_STEP_SUMMARY